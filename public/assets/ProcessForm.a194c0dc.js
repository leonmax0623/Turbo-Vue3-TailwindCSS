var e=Object.defineProperty,s=Object.defineProperties,l=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,t=(s,l,a)=>l in s?e(s,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[l]=a,r=(e,s)=>{for(var l in s||(s={}))o.call(s,l)&&t(e,l,s[l]);if(a)for(var l of a(s))i.call(s,l)&&t(e,l,s[l]);return e},p=(e,a)=>s(e,l(a));import{c as d,r as n,w as c,o as u,d as m,e as f,t as _,N as b,aK as g,W as v,X as h,u as k,n as V,S as x,H as y,ag as j,V as w,j as U,h as C,J as O,l as P,f as S,av as q,v as T,a2 as B}from"./vendor.36c281f3.js";import{_ as D}from"./Office.55bfbecd.js";import{_ as E}from"./Button.4b020695.js";import{u as z}from"./useSuspense.29183c13.js";import{p as A,_ as I}from"./StoSelect.c03bfa6a.js";import{_ as F}from"./Input.b03a61c6.js";import{_ as M}from"./Select.bf4a4e1e.js";import{a as N,b as $}from"./index.8fc70fb6.js";import{$ as H}from"./drop.cce90c26.js";import{j as J,u as K,s as W,q as X}from"./useAvatar.7737e550.js";import{s as G}from"./tasks.208e230d.js";import{d as L}from"./departments.4f88a00d.js";import{o as Q}from"./stages.6e22bacf.js";import{p as R}from"./index.a1f0654c.js";import{p as Y}from"./index.ce6adbb1.js";import{_ as Z}from"./Files.f3d09fe4.js";import{s as ee}from"./roles.e9bab731.js";import{u as se}from"./useConfirmDialog.ba73d887.js";import{s as le}from"./diagnostic-card.03bcc5f0.js";import"./headlessui.esm.b519f347.js";import"./Avatar.4eeca634.js";import"./Dropdown.df5c89e3.js";import"./NavBar.2f63176e.js";import"./meta.48f5205a.js";import"./Spinner.2e0ab286.js";import"./ExclamationCircleIcon.22c0ccb9.js";import"./Badge.4bd69676.js";import"./Dialog.b36041f9.js";const ae={class:"block text-sm font-medium text-gray-700 text-left"},oe=["disabled"],ie=["value"],te={props:{label:{type:String,required:!1,default:""},options:{type:Array,required:!1,default:[]},help:{type:String,required:!1,default:""},error:{type:String,required:!1,default:""},modelValue:{type:Array,required:!1},disabled:{type:Boolean,required:!1}},emits:["blured","update:modelValue"],setup(e,{emit:s}){const l=e,a=["mt-1 block w-full py-2 text-base focus:outline-none sm:text-sm rounded-md shadow-sm px-2"];l.error.length>0?a.push("border-red-300 focus:ring-red-500 focus:border-red-500"):a.push("border-gray-300 focus:ring-indigo-500 focus:border-indigo-500");const o=d((()=>{var e;return null==(e=l.options)?void 0:e.map((e=>e instanceof Object?e:{label:e,value:e}))})),i=n(l.modelValue);return c(i,(()=>{s("update:modelValue",i.value.filter((e=>null!=e)))})),(s,t)=>{var r;return u(),m("div",null,[f("label",ae,_(l.label),1),b(f("select",{class:V(a),multiple:"",onBlur:t[0]||(t[0]=e=>s.$emit("blured")),disabled:l.disabled,"onUpdate:modelValue":t[1]||(t[1]=e=>i.value=e)},[(u(!0),m(v,null,h(k(o),(e=>(u(),m("option",{class:"text-md",value:e.value,key:e.value},_(e.label),9,ie)))),128))],40,oe),[[g,i.value]]),f("p",{class:V(["mt-1 text-xs text-red-600",["text-"+(e.error.lenght?"red-600":"gray-500")]])},"  "+_(null!=(r=e.error)?r:e.help),3)])}}},{drop:re}=G,{current:pe}=L,de={id:"",name:"",description:"",role_id:"",order_stage_id:"",position:"",files:"",time:"",is_map:"false",map_id:""},ne={process_checkboxes:[{description:""}],pipelines:[{}],temp_file_ids:[],delete_file_ids:[],department_id:pe};let ce,ue;const me=function(e){var s,l,a,o,i,t,r;if(e.includes("_id")){if("temp_file_ids"===e)return;if("delete_file_ids"===e)return;ce[e]=null==(s=this[e.replace("_id","")])?void 0:s.id}else if("is_map"!==e){if("pipelines"!==e)return"process_checkboxes"===e?(ce.process_checkboxes=null!=(o=this.process_checkboxes)?o:de.process_checkboxes,void(0===ce.process_checkboxes.length&&ce.process_checkboxes.push(""))):void("process_categories"!==e?ce[e]=null!=(r=this[e])?r:de[e]:ce.process_categories=null!=(t=null==(i=this.process_categories)?void 0:i.map((({id:e})=>e)))?t:[]);ce.pipelines=null!=(a=null==(l=this.pipelines)?void 0:l.map((({pipeline:{id:e},stage:s})=>({pipeline_id:e,stage_id:null==s?void 0:s.id}))))?a:[{}]}else ce.is_map=this.is_map?"true":"false"},fe=e=>{ue.value=e.target.files};var _e=e=>x().run((()=>{const s=$(),{route:l,isThePage:a,redirectTo:o}=N("ProcessTaskEdit");ce||(ce=y(p(r(r({},J(de)),ne),{process_categories:[e]})),ue=n());return j((()=>{ce=void 0,ue=void 0,ne.process_checkboxes=[{description:""}],ne.pipelines=[{}],ne.temp_file_ids=[],ne.process_categories=[],ne.delete_file_ids=[]})),{fields:ce,isEditPage:a,saveTask:async()=>{var l,a,i;const t=null!=(a=null==(l=ue.value)?void 0:l.length)?a:0;if(t){const e=new FormData;for(let s=0;s<t;s++)e.append("files[]",ue.value[0]);const{message:l,success:a,data:o}=await K("temp/files",e);if(a?s.success("Файлы успешно загружены"):s.danger(null!=l?l:"Что-то пошло не так, не удалось загрузить файлы"),!a)return;ce.temp_file_ids=null==(i=null==o?void 0:o.files)?void 0:i.map((({id:e})=>e))}"true"===ce.is_map&&(delete ce.description,delete ce.process_checkboxes,delete ce.temp_file_ids);const{success:d}=await W.process_task(p(r({},ce),{is_map:"true"==ce.is_map,department_id:pe.value}),null,!0);d&&o({name:"Process",params:{id:e}})},atMounted:async()=>{if(!a.value)return;const{task:e}=l.params;if(e){let s={};s=await H.process_task(e),await(async e=>{Object.keys(ce).forEach(me,null!=e?e:{})})(s)}},log:fe,dropTask:async s=>{const{success:l,message:a}=await re(s);try{return{success:l,message:a}}finally{l&&o({name:"Process",params:{id:e}})}}}}));const be={class:"grid grid-cols-12 gap-6"},ge={class:"col-span-12 sm:col-span-4"},ve={class:"col-span-12 sm:col-span-4"},he={class:"col-span-12 sm:col-span-4"},ke={class:"col-span-12 sm:col-span-4"},Ve={class:"col-span-12 sm:col-span-4"},xe={class:"col-span-12 sm:col-span-4"},ye={class:"col-span-12 sm:col-span-6"},je={key:0,class:"col-span-12 sm:col-span-6"},we={class:"col-span-12 sm:col-span-12"},Ue=P("Удалить"),Ce=P("Добавить"),Oe={key:1,class:"col-span-12 grid grid-cols-12 gap-6"},Pe={class:"col-span-12 sm:col-span-12"},Se={class:"col-span-12 sm:col-span-12"},qe=f("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Чек лист",-1),Te={class:"w-5 pt-2"},Be=P("Удалить"),De=P("Добавить"),Ee=f("hr",{class:"col-span-12"},null,-1),ze={async setup(e){let s,l;const{options:a,load:o}=le,{simple:i}=se(),{load:t,options:r}=Q,{load:p,state:n,options:c}=Y,{load:b,options:g}=R,{options:V,load:x}=ee,{fields:y,atMounted:j,log:P}=_e(),S=A(n,y),q=e=>X((s=>e.splice(s,1)),d((()=>e.length>1)));let T,B;[s,l]=w((()=>Promise.all([x(),p(),j(),t(),b(),o()]).then((()=>{T=q(y.process_checkboxes),B=q(y.pipelines)})))),s=await s,l();const D=[{label:"Задача",value:"false"},{label:"Диагностическая карта",value:"true"}];return(e,s)=>(u(),m("div",be,[f("div",ge,[U(M,{"hide-text":!0,label:"Тип",modelValue:k(y).is_map,"onUpdate:modelValue":s[0]||(s[0]=e=>k(y).is_map=e),options:D},null,8,["modelValue"])]),f("div",ve,[U(F,{label:"Название задачи",modelValue:k(y).name,"onUpdate:modelValue":s[1]||(s[1]=e=>k(y).name=e)},null,8,["modelValue"])]),f("div",he,[U(F,{label:"Времени на выполнение (в часах)",type:"number",modelValue:k(y).time,"onUpdate:modelValue":s[2]||(s[2]=e=>k(y).time=e)},null,8,["modelValue"])]),f("div",ke,[U(F,{label:"Позиция",type:"number",modelValue:k(y).position,"onUpdate:modelValue":s[3]||(s[3]=e=>k(y).position=e)},null,8,["modelValue"])]),f("div",Ve,[U(M,{label:"Этап заказ-нарядa",options:k(r),modelValue:k(y).order_stage_id,"onUpdate:modelValue":s[4]||(s[4]=e=>k(y).order_stage_id=e)},null,8,["options","modelValue"])]),f("div",xe,[U(M,{label:"Роль исполнителя",options:k(V),modelValue:k(y).role_id,"onUpdate:modelValue":s[5]||(s[5]=e=>k(y).role_id=e)},null,8,["options","modelValue"])]),f("div",ye,[U(te,{label:"Категории процессов",options:k(g),modelValue:k(y).process_categories,"onUpdate:modelValue":s[6]||(s[6]=e=>k(y).process_categories=e)},null,8,["options","modelValue"])]),"true"==k(y).is_map?(u(),m("div",je,[U(M,{label:"Шаблон диагностической карты",options:k(a),modelValue:k(y).map_id,"onUpdate:modelValue":s[7]||(s[7]=e=>k(y).map_id=e)},null,8,["options","modelValue"])])):C("",!0),f("div",we,[f("ul",null,[(u(!0),m(v,null,h(k(y).pipelines,((e,s)=>(u(),m("li",{key:"input-"+s,class:"flex items-center"},[U(M,{class:"mr-3 pipeline w-full",label:`Воронка ${s+1}`,options:k(c),modelValue:k(y).pipelines[s].pipeline_id,"onUpdate:modelValue":e=>k(y).pipelines[s].pipeline_id=e},null,8,["label","options","modelValue","onUpdate:modelValue"]),U(k(S),{index:s,pipeline_id:k(y).pipelines[s].pipeline_id,modelValue:k(y).pipelines[s].stage_id,"onUpdate:modelValue":e=>k(y).pipelines[s].stage_id=e},null,8,["index","pipeline_id","modelValue","onUpdate:modelValue"]),U(E,{color:"red",size:"sm",onClick:e=>k(B)(s)},{default:O((()=>[Ue])),_:2},1032,["onClick"])])))),128))]),U(E,{size:"xs",class:"mt-4",onClick:s[8]||(s[8]=e=>k(y).pipelines.push({}))},{default:O((()=>[Ce])),_:1})]),"false"==k(y).is_map?(u(),m("div",Oe,[f("div",Pe,[U(I,{label:"Текст задачи",modelValue:k(y).description,"onUpdate:modelValue":s[9]||(s[9]=e=>k(y).description=e)},null,8,["modelValue"])]),f("div",Se,[qe,f("ul",null,[(u(!0),m(v,null,h(k(y).process_checkboxes,((e,s)=>(u(),m("li",{key:"input-"+s,class:"flex items-start mb-2"},[f("span",Te,_(s+1),1),U(F,{rows:"1",class:"flex-grow mx-2",placeholder:"Текст задачи",modelValue:k(y).process_checkboxes[s].description,"onUpdate:modelValue":e=>k(y).process_checkboxes[s].description=e},null,8,["modelValue","onUpdate:modelValue"]),U(E,{color:"red",size:"sm",onClick:e=>k(T)(s)},{default:O((()=>[Be])),_:2},1032,["onClick"])])))),128))]),U(E,{size:"xs",class:"mt-4",onClick:s[10]||(s[10]=e=>k(y).process_checkboxes.push({description:""}))},{default:O((()=>[De])),_:1})]),Ee,U(Z,{log:k(P),files:k(y).files,onFileDropped:s[11]||(s[11]=e=>k(i)((()=>(e=>{y.delete_file_ids.push(e),y.files.deleteById(e)})(e))))},null,8,["log","files"])])):C("",!0)]))}},Ae=P("К задачам процесса "),Ie=P("Сохранить "),Fe=P("Удалить "),Me={setup(e){const{drop:s}=se(),{route:l,back:a}=N(),{isEditPage:o,saveTask:i,dropTask:t}=_e(l.params.id),r=z(ze);return(e,p)=>(u(),S(D,{title:k(o)?"Обновление задачи":"Создание новой задачи"},{actions:O((()=>[U(E,{type:"secondary",onClick:k(a)},{default:O((()=>[U(k(q),{class:"w-5 h-5 mr-1"}),Ae])),_:1},8,["onClick"]),U(E,{color:"green",onClick:k(i)},{default:O((()=>[U(k(T),{class:"w-5 h-5 mr-1"}),Ie])),_:1},8,["onClick"]),k(o)?(u(),S(E,{key:0,color:"red",onClick:p[0]||(p[0]=()=>k(s)((()=>k(t)(k(l).params.task))))},{default:O((()=>[U(k(B),{class:"w-5 h-5 mr-1"}),Fe])),_:1})):C("",!0)])),default:O((()=>[U(k(r))])),_:1},8,["title"]))}};export{Me as default};
