import{V as e,o as a,d as s,j as o,u as l,H as t,a as r,S as m,c as n,ag as i,f as d,J as u,l as c,t as p,A as f,e as b,a3 as v}from"./vendor.36c281f3.js";import{_ as j}from"./Button.4b020695.js";import{_ as w}from"./Input.b03a61c6.js";import{_}from"./Select.bf4a4e1e.js";import{_ as y}from"./TextArea.fcc59b75.js";import{s as k}from"./employees.2bffecd5.js";import{d as V}from"./departments.4f88a00d.js";import{s as g,c as h}from"./useAvatar.7737e550.js";import{u as C}from"./useModalForm.1c23c14e.js";import{a as I,b as q}from"./index.8fc70fb6.js";import{$ as x,_ as A}from"./drop.cce90c26.js";import{a as F}from"./OrderForm.cc8dadca.js";import{_ as S}from"./Link.4e9a6f0f.js";import{_ as U}from"./Avatar.4eeca634.js";import{_ as D}from"./Table.ec42ea9a.js";import{u as O}from"./useConfirmDialog.ba73d887.js";import{u as B}from"./useSuspense.29183c13.js";import"./ExclamationCircleIcon.22c0ccb9.js";import"./FormActions.47218f8a.js";import"./Spinner.2e0ab286.js";import"./Office.55bfbecd.js";import"./headlessui.esm.b519f347.js";import"./Dropdown.df5c89e3.js";import"./NavBar.2f63176e.js";import"./meta.48f5205a.js";import"./orders.a1ebe807.js";import"./Th.32cd08d3.js";import"./useIntersectionObserver.7ad3d6a4.js";import"./Dialog.b36041f9.js";const M={async setup(t){let r,m;const{load:n,options:i}=k,{current:d}=V,{atMounted:u,work:c}=P();return[r,m]=e((()=>Promise.all([u(),n({department_id:d.value})]))),r=await r,m(),(e,t)=>(a(),s("div",null,[o(w,{label:"Вид работы",required:!0,modelValue:l(c).name,"onUpdate:modelValue":t[0]||(t[0]=e=>l(c).name=e),class:"sm:col-span-6 col-span-12"},null,8,["modelValue"]),o(w,{label:"Стоимость",type:"number",required:!0,modelValue:l(c).sum,"onUpdate:modelValue":t[1]||(t[1]=e=>l(c).sum=e),class:"sm:col-span-6 col-span-12"},null,8,["modelValue"]),o(_,{label:"Исполнитель",options:l(i),required:!0,modelValue:l(c).user_id,"onUpdate:modelValue":t[2]||(t[2]=e=>l(c).user_id=e),class:"sm:col-span-6 col-span-12"},null,8,["options","modelValue"]),o(w,{label:"Время",type:"number",required:!0,modelValue:l(c).time,"onUpdate:modelValue":t[3]||(t[3]=e=>l(c).time=e),class:"sm:col-span-6 col-span-12"},null,8,["modelValue"]),o(y,{label:"Комментарии",required:!0,modelValue:l(c).comments,"onUpdate:modelValue":t[4]||(t[4]=e=>l(c).comments=e),class:"sm:col-span-6 col-span-12"},null,8,["modelValue"])]))}},T=t({raw:[]});var $={state:r(T),load:async e=>{T.raw=await x.works(e)},drop:async e=>A.work(e,(e=>T.raw.deleteById(e))),add:e=>{const a=T.raw.findIndex((({id:a})=>(null==e?void 0:e.id)==a));a<0?T.raw.push(e):T.raw[a]=e},reset:()=>{T.raw=[]}};const E=q(),{add:H}=$;let J;const L=async e=>{const{message:a,success:s,data:o}=await g.work(J);try{return{message:a,success:s}}finally{s&&(H(o.work),await F(e),E.success(a))}},N=async()=>{const{id:e}=J;if(e){((e={})=>{var a,s;J.id=null==e?void 0:e.id,J.name=null==e?void 0:e.name,J.comments=null==e?void 0:e.comments,J.time=null==e?void 0:e.time,J.sum=null==e?void 0:e.sum,J.order_id=null==(a=null==e?void 0:e.order)?void 0:a.id,J.user_id=null==(s=null==e?void 0:e.user)?void 0:s.id})(await x.work(e)||{})}};function P(){const{route:e}=I();return{saveForm:L,work:J,atMounted:N,render:(...a)=>{const s=m();s.run((()=>{const o=n((()=>!!J.id)),{render:l}=C({title:n((()=>h.modal[o.value?"update":"create"].work)),RawForm:M,atSubmit:()=>L(e.params.id),atClose:()=>s.stop(),atOpen:a=>{J=t({id:null!=a?a:"",name:"",order_id:e.params.id,user_id:"",comments:"",sum:"",time:""})}});l(...a),i((()=>{J=void 0}))}))}}}const R=c("суммa"),z={async setup(s){let t,r;const{render:m}=P(),{route:n}=I(),{drop:i}=O(),{load:f,state:b,drop:v}=$,j=[{label:"Вид работы",key:"name"},{label:"Исполнитель",key:"user"},{label:"Стоимость",key:"sum"},{label:"Время",key:"time"},{label:"Комментарии",key:"comments"}];return[t,r]=e((()=>f({order_id:n.params.id}))),t=await t,r(),(e,s)=>(a(),d(D,{key:l(b).raw.length,fields:j,items:l(b).raw,onDelete:s[0]||(s[0]=e=>l(i)((()=>(async e=>{const a=await v(e);try{return a}finally{await F(n.params.id)}})(e)))),onEdit:s[1]||(s[1]=e=>l(m)(e)),last:!!l(b).raw.length},{"td-name":u((({value:e,item:{id:a}})=>[o(S,{onClick:()=>l(m)(a)},{default:u((()=>[c(p(e),1)])),_:2},1032,["onClick"])])),"td-sum":u((({value:e})=>[c(p(null!=e?e:"_")+" ₽ ",1)])),"td-user":u((({value:e})=>{var a,s;return[o(U,{title:`${null!=(a=e.name)?a:""} ${null!=(s=e.middle_name)?s:""}`,subtitle:e.office_position,image:e.avatar},null,8,["title","subtitle","image"])]})),"td-time":u((({value:e})=>[c(p(e?`${e} Ч`:"_"),1)])),"td-comments":u((({value:e})=>[c(p(null!=e?e:"_"),1)])),"td-last-name":u((({})=>[R])),"td-last-sum":u((({items:e})=>[c(p(e.reduce(((e,a)=>e+(parseInt(a.sum)||0)),0))+" ₽",1)])),_:1},8,["items","last"]))}},G={class:"mb-5"},K=c("Добавить работу "),Q={setup(e){const t=B(z),{render:r}=P();return(e,m)=>{const n=f("v-can");return a(),s("div",null,[b("div",G,[o(n,{ability:"crud works"},{default:u((()=>[o(j,{color:"blue",onClick:m[0]||(m[0]=()=>l(r)())},{default:u((()=>[o(l(v),{class:"w-5 h-5 mr-1"}),K])),_:1})])),_:1})]),o(l(t))])}}};export{Q as default};
