var e=Object.defineProperty,l=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,t=(l,a,s)=>a in l?e(l,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[a]=s,o=(e,o)=>{for(var n in o||(o={}))a.call(o,n)&&t(e,n,o[n]);if(l)for(var n of l(o))s.call(o,n)&&t(e,n,o[n]);return e};import{r as n}from"./CheckIcon.6fe7075c.js";import{r,a as u,_ as i}from"./Feeds.7577bc82.js";import{S as d,r as c,c as m,V as v,o as p,d as f,e as b,j as k,J as _,u as y,aE as g,t as h,l as x,f as j,W as w,X as T,h as A,n as $,aF as S,L as C,M as D,ag as E,av as B}from"./vendor.36c281f3.js";import{_ as M}from"./Work.601ec4a0.js";import{_ as I}from"./Button.4b020695.js";import{d as K,a as O,f as P,b as U}from"./index.8fc70fb6.js";import{a as V,s as L,l as W,g as F,w as H}from"./useAvatar.7737e550.js";import{$ as R}from"./drop.cce90c26.js";import q from"./Comments.ea5d3474.js";import{_ as J,b as X,a as z}from"./DescriptionListItems.7babd672.js";import{_ as G}from"./Checkbox.452236a5.js";import{_ as N}from"./DiagnosticCardPreview.d449045c.js";import{_ as Q}from"./Badge.4bd69676.js";import{u as Y}from"./useSuspense.29183c13.js";import"./meta.48f5205a.js";import"./departments.4f88a00d.js";import"./TextArea.fcc59b75.js";import"./ExclamationCircleIcon.22c0ccb9.js";import"./Avatar.4eeca634.js";import"./Spinner.2e0ab286.js";const{user:Z}=K(),ee=U();let le,ae,se;var te=()=>d().run((()=>{const{route:e,back:l}=O();le||(le=c({}),se=m((()=>{var e,l;return(null==(e=le.value.user)?void 0:e.id)==Z.value.id||(null==(l=le.value.author)?void 0:l.id)==Z.value.id})),ae=m((()=>"process"===le.value.status&&P(le.value,"update"))));const a=V((async(e,l,a)=>{const{success:s,message:t}=await L({path:`tasks/checkboxes/${e}/status`,data:{is_checked:l}});s||(ee.danger(null!=t?t:"Не удалось изменить статус флажка"),le.value.checkboxes[a].is_checked=!l)})),s=e.params.id;return{canTasks:P,task:le,atMounted:async()=>{const{id:a}=e.params;le.value=await R.task(a),le.value.id||l()},checkBox:a,back:l,route:e,ping:async e=>{if(e===le.value.status)return;const l=`tasks/${s}/to/${e}`,{success:a,message:t,data:o}=await L({path:l});a&&(le.value=null==o?void 0:o.task);const n=null!=t?t:a?"Статус успешно изменен":"Не удалось изменить статус задача";ee[a?"success":"danger"](n)},task_id:s,allowed:ae,engagedIn:se,clearMemo:()=>{le=void 0,ae=void 0}}}));const oe={class:"text-right"},ne={class:"text-sm flex items-center mb-3"},re=b("span",{class:"mr-1"},"Крайний срок:",-1),ue={class:"text-gray-500"},ie=["innerHTML"],de={class:"mt-4 text-sm text-gray-400"},ce={role:"list",class:"border border-gray-200 rounded-md divide-y divide-gray-200"},me={class:"w-0 flex-1 flex items-center"},ve={class:"ml-2 flex-1 w-0 truncate"},pe={class:"ml-4 flex-shrink-0"},fe=["disabled","href"],be={async setup(e){let l,a;const{task:s,atMounted:t,route:o,checkBox:n,allowed:r}=te(),u=c({});return[l,a]=v((()=>t().then((async()=>{s.value.is_map&&(u.value=await R.map(s.value.task_map.map_id))})))),l=await l,a(),(e,l)=>{var a,t,i,d,c;return p(),f("div",null,[b("section",null,[k(y(z),{title:null==(a=y(s))?void 0:a.name,subtitle:(null==(i=null==(t=y(s))?void 0:t.order)?void 0:i.id)?`Заказ-наряд #${y(F)(null==(c=null==(d=y(s))?void 0:d.order)?void 0:c.id)}`:"",type:"columns"},{"right-title":_((()=>{var e;return[b("div",oe,[b("div",ne,[k(y(g),{class:"w-4 h-4 mr-1"}),re,b("span",ue,h(null!=(e=y(s).deadline_at)?e:""),1)]),k(Q,{point:!0,color:y(W)[y(s).status].color},{default:_((()=>[x(h(y(W)[y(s).status].label),1)])),_:1},8,["color"])])]})),default:_((()=>[k(y(J),{type:"columns",cols:3},{default:_((()=>{var e,l,a,t,o,i,d,c,m,v,g,x,C,D,E,B,M,I,K,O,P,U,V,L,W,F,H;return[k(y(X),{cols:"1",label:"Автомобиль",value:`${null!=(i=null==(o=null==(t=null==(a=null==(l=null==(e=y(s))?void 0:e.order)?void 0:l.car)?void 0:a.car_model)?void 0:t.car_mark)?void 0:o.name)?i:""} ${null!=(g=null==(v=null==(m=null==(c=null==(d=y(s))?void 0:d.order)?void 0:c.car)?void 0:m.car_model)?void 0:v.name)?g:"_"}`,type:"columns"},null,8,["value"]),k(y(X),{cols:"1",label:"ГОС номер",value:null!=(E=null==(D=null==(C=null==(x=y(s))?void 0:x.order)?void 0:C.car)?void 0:D.number)?E:"",type:"columns"},null,8,["value"]),k(y(X),{cols:"1",label:"Клиент",value:`${null!=(K=null==(I=null==(M=null==(B=y(s))?void 0:B.order)?void 0:M.client)?void 0:I.name)?K:""} ${null!=(V=null==(U=null==(P=null==(O=y(s))?void 0:O.order)?void 0:P.client)?void 0:U.middle_name)?V:""}`,type:"columns"},null,8,["value"]),y(s).is_map?(p(),j(y(X),{key:1,cols:"3",label:"",type:"columns",columns:"2"},{default:_((()=>{var e;return[k(N,{for_worker:!0,task_id:y(s).id,map_answer:y(s).map_answer,fields:null!=(e=u.value.data)?e:[],dc_template:u.value,"no-head":!0,disabled:!y(r)},null,8,["task_id","map_answer","fields","dc_template","disabled"])]})),_:1})):(p(),j(y(X),{key:0,cols:"3",label:"Задача",type:"columns",columns:"2"},{default:_((()=>[b("p",{innerHTML:y(s).description},null,8,ie)])),_:1})),(null==(W=null==(L=y(s))?void 0:L.checkboxes)?void 0:W.length)&&!y(s).is_map?(p(),j(y(X),{key:2,cols:"3",label:"Чек лист",type:"columns",columns:"2"},{default:_((()=>{var e,l,a,t;return[b("ul",null,[(p(!0),f(w,null,T(y(s).checkboxes,((e,l)=>(p(),f("li",{key:e.id,class:$(["py-2",{"line-through":e.is_checked}])},[k(G,{disabled:!y(r),label:e.description,modelValue:e.is_checked,"onUpdate:modelValue":l=>e.is_checked=l,onClicked:()=>y(n)(e.id,!e.is_checked,l)},null,8,["disabled","label","modelValue","onUpdate:modelValue","onClicked"])],2)))),128))]),b("span",de," Выполнено: "+h(null==(l=null==(e=y(s))?void 0:e.checkboxes)?void 0:l.filter((e=>e.is_checked)).length)+" из "+h(null==(t=null==(a=y(s))?void 0:a.checkboxes)?void 0:t.length),1)]})),_:1})):A("",!0),(null==(F=y(s).files)?void 0:F.length)&&!y(s).is_map?(p(),j(y(X),{key:3,cols:"3",label:"Вложения",type:"columns",columns:"2"},{default:_((()=>[b("ul",ce,[(p(!0),f(w,null,T(y(s).files,(e=>(p(),f("li",{key:`${e.id}-file`,class:"pl-3 pr-4 py-3 flex items-center justify-between text-sm"},[b("div",me,[k(y(S),{class:"w-4 h-4"}),b("span",ve,h(e.name),1)]),b("div",pe,[b("a",{disabled:!y(r),href:e.url,target:"_blank",class:"font-medium text-blue-600 hover:text-blue-500"},"Скачать",8,fe)])])))),128))])])),_:1})):A("",!0),(null==(H=y(s).order)?void 0:H.comment)?(p(),j(y(X),{key:4,cols:"3",label:"Комментарий заказ наряда",type:"columns",columns:"1"},{default:_((()=>{var e;return[b("p",null,h(null==(e=y(s).order)?void 0:e.comment),1)]})),_:1})):A("",!0)]})),_:1})])),_:1},8,["title","subtitle"])]),k(q,{title:"Комментарии к задаче / Заментки",model:"task",id:y(o).params.id,class:"mt-2"},null,8,["id"])])}}};C("data-v-64261845");const ke=x("К задачам "),_e={class:"grid grid-cols-1 gap-6 lg:grid-flow-col-dense lg:grid-cols-6 "},ye={class:"space-y-6 lg:col-start-1 lg:col-span-4"},ge={"aria-labelledby":"timeline-title",class:"lg:col-start-5 lg:col-span-2 relative"},he={class:"bg-white px-4 py-5 shadow sm:rounded-lg sm:px-6 sticky top-3"},xe=b("h2",{id:"timeline-title",class:"text-lg font-medium text-gray-900"},"Выполнено по текущему процессу",-1),je=x(" Начать "),we=x(" На паузу "),Te=x(" Завершить ");D();const Ae={setup(e){const{query:l}=O(),a=Y(be),{task:s,clearMemo:t,ping:d,engagedIn:c,canTasks:v}=te();E(t);const g=m((()=>{var e,l,a;return("wait"===(null==(e=s.value)?void 0:e.status)||"done"===(null==(l=s.value)?void 0:l.status)||"pause"===(null==(a=s.value)?void 0:a.status))&&v(s.value,"update_status")})),h=m((()=>{var e,l;return("process"===(null==(e=s.value)?void 0:e.status)||"wait"===(null==(l=s.value)?void 0:l.status))&&v(s.value,"update_status")})),x=m((()=>{var e,l;return("process"===(null==(e=s.value)?void 0:e.status)||"pause"===(null==(l=s.value)?void 0:l.status))&&v(s.value,"update_status")})),w={TASK_CREATED:{iconBackground:"bg-gray-400",icon:r},TASK_STATUS:{iconBackground:"bg-green-500",icon:n},TASK_UPDATED:{iconBackground:"bg-blue-500",icon:u}},T=m((()=>{var e,l;const a=[];return null==(l=null==(e=null==s?void 0:s.value)?void 0:e.logs)||l.forEach((({created_at:e,created_user:l,data:t,type:n},r)=>{var u,i;if("task_updated"===n&&"status"in t)return;const{ev:d,content:c}=(({type:e,status:l})=>{const a={};return"task_created"===e&&(a.ev="TASK_CREATED",a.content="Поставлено на"),"task_updated"===e&&(a.ev="TASK_UPDATED",a.content="Задача обновлена"),"task_status"===e&&(a.ev="TASK_STATUS",a.content=`Статус изменен (${W[l].label})`),a})(o({type:n},t));if(!d||!c)return;const m=new Date(e.split(" ")[0]),v=`${m.getDate()} ${H[m.getMonth()]} ${e.split(" ")[1].substr(0,5)}`;"task_created"===n&&(l=s.value.user);const p={id:r,content:c,target:`${null!=(u=null==l?void 0:l.name)?u:""} ${null!=(i=null==l?void 0:l.middle_name)?i:""}`,date:v,datetime:e,data:o({},t),icon:w[d].icon,iconBackground:w[d].iconBackground};a.push(p)})),a}));return(e,t)=>{var o;return p(),j(M,{title:null==(o=y(s))?void 0:o.name},{actions:_((()=>["tasks"===y(l).from?(p(),j(I,{key:0,type:"secondary",link:{name:"WorkerTasks"}},{default:_((()=>[k(y(B),{class:"w-5 h-5 mr-1"}),ke])),_:1})):A("",!0)])),default:_((()=>[b("div",_e,[b("div",ye,[k(y(a))]),b("section",ge,[b("div",he,[xe,k(i,{items:y(T),class:"mt-5 max-h-vh overflow-y-scroll"},null,8,["items"]),(p(),f("div",{class:"mt-6 flex justify-center gap-3",key:y(s).status},[y(g)?(p(),j(I,{key:0,blur:"",class:"flex justify-center",color:"purple",onClick:t[0]||(t[0]=()=>y(d)("process")),disabled:!y(g)},{default:_((()=>[je])),_:1},8,["disabled"])):A("",!0),y(h)?(p(),j(I,{key:1,blur:"",class:"flex justify-center",onClick:t[1]||(t[1]=()=>y(d)("pause")),color:"yellow",disabled:!y(h)},{default:_((()=>[we])),_:1},8,["disabled"])):A("",!0),y(x)?(p(),j(I,{key:2,blur:"",class:"flex justify-center",color:"green",onClick:t[2]||(t[2]=()=>y(d)("done")),disabled:!y(x)},{default:_((()=>[Te])),_:1},8,["disabled"])):A("",!0)]))])])])])),_:1},8,["title"])}},__scopeId:"data-v-64261845"};export{Ae as default};
