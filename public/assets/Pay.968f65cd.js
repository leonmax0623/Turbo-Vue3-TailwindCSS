var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,o=(a,t,r)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[t]=r,l=(e,a)=>{for(var t in a||(a={}))n.call(a,t)&&o(e,t,a[t]);if(r)for(var t of r(a))s.call(a,t)&&o(e,t,a[t]);return e},u=(e,r)=>a(e,t(r));import{V as i,U as d,c as p,w as c,A as m,o as y,d as v,j as _,u as f,f as g,h as b,J as w,E as $,F as h,H as j,a as V,S as k,ag as O,I as F,n as q,$ as B,l as S,t as M}from"./vendor.36c281f3.js";import{c as P,s as U}from"./useAvatar.7737e550.js";import{$ as I,_ as R}from"./drop.cce90c26.js";import{c as x,a as E,b as T,u as C}from"./index.8fc70fb6.js";import{u as D}from"./useModalForm.1c23c14e.js";import{_ as W}from"./Input.b03a61c6.js";import{_ as A}from"./Select.bf4a4e1e.js";import{d as z}from"./departments.4f88a00d.js";import{s as H}from"./groups.5d62c0cb.js";import{o as J}from"./orders.a1ebe807.js";import{o as L}from"./useOrder.941ce970.js";import{_ as N}from"./Link.4e9a6f0f.js";import{_ as G}from"./Badge.4bd69676.js";const K={async setup(e){let a,t;const{options:r,load:n}=H,{current:s,options:o}=z,{load:l,options:u,state:$}=J,{finance:h,atMountedFinanceForm:j,v$:V,types:k,payment_types:O,isThePage:F}=pe();[a,t]=i((()=>Promise.all([n(),l({department_id:s.value}),j()]))),a=await a,t();const q=d(!0),B=p((()=>null!=h.id&&""!=h.id)),S=p((()=>"inProgress"==h.status||"ready"==h.status));c((()=>h.order_id),(e=>{var a,t,r;const n=$.raw.find((({id:a})=>a==e));B.value?(null!=(a=n.total_paid_sum)?a:0)<(null!=(t=n.total_sum)?t:0)&&"sellReturn"!=h.operation_type?(h.sum=n.total_pay_sum,q.value=!1):q.value=!0:(h.sum=null!=(r=null==n?void 0:n.total_sum)?r:0,q.value=!0)}),{immediate:!0});const M=({value:e})=>!e.startsWith("buy");return(e,a)=>{var t,n,s,l,i,d;const p=m("v-can");return y(),v("div",null,[_(A,{label:"Тип операции",modelValue:f(h).operation_type,"onUpdate:modelValue":a[0]||(a[0]=e=>f(h).operation_type=e),options:f(F)?f(k).filter(M):f(k),required:!0,error:null==(t=f(V).operation_type.$errors[0])?void 0:t.$message,onBlured:f(V).operation_type.$touch,disabled:f(B)&&f(S)},null,8,["modelValue","options","error","onBlured","disabled"]),_(A,{required:!0,label:"Заказ-наряд",modelValue:f(h).order_id,"onUpdate:modelValue":a[1]||(a[1]=e=>f(h).order_id=e),options:f(u),disabled:f(B)&&f(S)||f(F)||"buy"===f(h).operation_type||"buyReturn"===f(h).operation_type},null,8,["modelValue","options","disabled"]),_(W,{label:"Название финансовой сделки",modelValue:f(h).name,"onUpdate:modelValue":a[2]||(a[2]=e=>f(h).name=e),required:!0,error:null==(n=f(V).name.$errors[0])?void 0:n.$message,onBlured:f(V).name.$touch},null,8,["modelValue","error","onBlured"]),_(W,{label:"Сумма",modelValue:f(h).sum,"onUpdate:modelValue":a[3]||(a[3]=e=>f(h).sum=e),type:"number",min:0,step:1,required:!0,error:null!=(l=null==(s=f(V).sum.$errors[0])?void 0:s.$message)?l:f(q)?"":`Нужно доплатить: ${f(h).sum} ₽`,onBlured:f(V).sum.$touch,disabled:e.disabledSum},null,8,["modelValue","error","onBlured","disabled"]),_(A,{label:"Вид оплаты",modelValue:f(h).payment_type,"onUpdate:modelValue":a[4]||(a[4]=e=>f(h).payment_type=e),options:f(O),required:!0,error:null==(i=f(V).payment_type.$errors[0])?void 0:i.$message,onBlured:f(V).payment_type.$touch},null,8,["modelValue","options","error","onBlured"]),f(F)?b("",!0):(y(),g(A,{key:0,label:"Группа",modelValue:f(h).finance_group_id,"onUpdate:modelValue":a[5]||(a[5]=e=>f(h).finance_group_id=e),options:f(r),required:!0,error:null==(d=f(V).finance_group_id.$errors[0])?void 0:d.$message,onBlured:f(V).finance_group_id.$touch},null,8,["modelValue","options","error","onBlured"])),f(F)?b("",!0):(y(),g(p,{key:1,ability:"crud departments"},{default:w((()=>[_(A,{label:"Отделение",modelValue:f(h).department_id,"onUpdate:modelValue":a[6]||(a[6]=e=>f(h).department_id=e),required:!0,options:f(o)},null,8,["modelValue","options"])])),_:1}))])}}};const Q=x("crud finances"),X=j({raw:[],pages:100,page:1,pending:!1});var Y={state:V(X),load:async(e={})=>{Q&&(X.raw=await I.finances(e))},drop:async e=>R.finance(e,(e=>{X.raw.deleteById(e)})),reset:()=>{X.raw=[],X.pages=100,X.page=1},sort:e=>{X.raw.sort(e)},fill:async e=>{var a,t,r;if(X.pending)return;if(X.page>X.pages)return;X.pending=!0;const n=await I({key:"finances",params:u(l({},e),{page:X.page})});X.raw=X.raw.concat(null!=(a=null==n?void 0:n.finances)?a:[]),X.pages=null!=(r=null==(t=null==n?void 0:n.meta)?void 0:t.last_page)?r:100,X.page+=1,X.pending=!1},updateStatus:(e,a)=>{const t=X.raw.findIndex((({id:a})=>e==a));t<0||(X.raw[t].status=a)},addFinance:e=>{const a=X.raw.findIndex((({id:a})=>(null==e?void 0:e.id)==a));a<0?X.raw.unshift(e):X.raw[a]=e}};const{current:Z}=z,{addFinance:ee}=Y,ae=T();let te,re,ne,se,oe,le;const ue=()=>{le=void 0,te=void 0,re=void 0,ne=void 0,se=void 0,oe=void 0},ie=function(e){var a,t,r,n;if(e.includes("_id"))return"department_id"===e?void(te.department_id=null!=(t=null==(a=this.department)?void 0:a.id)?t:Z.value):void(te[e]=null==(r=this[e.replace("_id","")])?void 0:r.id);te[e]=null!=(n=this[e])?n:""},de=async()=>{const{id:e}=te;let a={};e&&(a=await I.finance(e),((e={})=>{Object.keys(te).forEach(ie,e)})(a))};function pe(){const{isThePage:e}=E("OrderEdit");le||(le=e);const a=async()=>{if(!(await re.value.$validate()))return;re.value.$reset();const{message:e,success:a,data:t}=await U.finance(te);try{return{message:e,success:a}}finally{a&&(ee(t.finance),ae.success(e))}};return ne||(se=d({}),ne=p((()=>{var e;return Object.entries(null!=(e=se.value.operations)?e:{}).map((([e,a])=>({label:a,value:e})))})),oe=p((()=>{var e;return Object.entries(null!=(e=se.value.payments)?e:{}).map((([e,a])=>({label:a,value:e})))}))),{render:(...e)=>{const t=k();t.run((()=>{const r=p((()=>!!te.id)),n=p((()=>r.value?te.order_id?"Подробности":P.modal.update.finance:P.modal.create[le.value?"payment":"finance"])),{render:s}=D({title:n,RawForm:K,atSubmit:a,atClose:()=>t.stop(),atOpen:(e,a)=>{var t;te||(te=j({id:null!=e?e:"",name:"",operation_type:"",payment_type:"",sum:"",finance_group_id:"",order_id:a,department_id:Z.value}),re=F((t=le.value,p((()=>{const e={name:{required:$.withMessage("Укажите имя",h)},operation_type:{required:$.withMessage("Выберите тип",h)},payment_type:{required:$.withMessage("Выберите Вид оплаты",h)},sum:{required:$.withMessage("Укажите сумму",h)}};return t||(e.finance_group_id={required:$.withMessage("Выберите финансовую группу",h)}),e}))),te,{$lazy:!0}))}},{right:"Провести"});s(...e),O((()=>{te=void 0,re=void 0}))}))},atMountedFinanceForm:de,finance:te,v$:re,current:Z,types:ne,typesMapper:se,payment_types:oe,cleanUpForm:ue,isThePage:le,finance_color_map:{sell:"process",sellReturn:"cancel",buy:"wait",buyReturn:"cancel"}}}let ce;const{current:me}=z,{sort:ye,fill:ve,reset:_e,state:fe,drop:ge}=Y,be={id:{label:"По умолчанию",sort:(e,a)=>e.id-a.id},name:{label:"По имени",sort:(e,a)=>e.name>a.name?1:e.name<a.name?-1:0},operation_type:{label:"По типу",sort:(e,a)=>e.operation_type>a.operation_type?1:e.operation_type<a.operation_type?-1:0},sum:{label:"По сумме",sort:(e,a)=>e.sum-a.sum},date:{label:"По дате",sort:(e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()}};let we;function $e(e){we||(we=j({name:"",operation_type:"",sum:"",start_date:"",end_date:"",order:""}));const a=L(be,"id",(e=>{ye(e)}),1);return ce||(ce=async(a=!1)=>{a&&_e(),await ve(u(l({},we),{order_id:e,department_id:e?void 0:me.value}))}),{order:a,filter:we,resetFilter:()=>{Object.keys(we).forEach((e=>{"department_id"!==e&&(we[e]="")}))},fetchFinances:ce,current:me,state:fe,drop:ge,cleanUp:()=>{we=void 0,ce=void 0,_e()}}}const he=T();const je={class:"flex items-center"},Ve=["disabled","data-tooltip"],ke=S(" Оплатить "),Oe={props:{status:{type:[String,null]},resource:{type:[String,null],default:"finance"},id:{type:[String,Number]},cb:{type:Function,default:()=>{}},paymentWrapper:{type:Function}},setup(e){const a=e,{loading:t,checkStatus:r,pay:n}=(({resource:e="finance",cb:a=(()=>{})})=>{const{apiRequest:t}=C(),{call:r,data:n,errorMsg:s,success:o,loading:l,reset:u,error:i}=t();return{pay:async t=>{var d;if(!l.value)return u(),await r(`${e}s/${t}/payment`),o.value?n.value[`${e}_log`].status?a(t,null!=(d=n.value[`${e}_log`].status)?d:"unknown"):he.warn("Статус не установлен, проверьте, прошел ли платеж"):422==i.value.response.status?he.danger(s.value):he.danger("Что-то пошло не так"),{success:o.value,message:s.value||"Что-то пошло не так"}},checkStatus:async t=>{var d;if(!l.value)return u(),await r(`${e}s/${t}/payment-status`),o.value?n.value[`${e}_log`].status?a(t,null!=(d=n.value[`${e}_log`].status)?d:"unknown"):he.warn("Статус не установлен, Не удалось проверить"):422==i.value.response.status?he.danger(s.value):he.danger("Что-то пошло не так"),{success:o.value,message:s.value||"Что-то пошло не так"}},loading:l}})({resource:a.resource,cb:a.cb}),s={inprogress:{color:"yellow",label:"Ожидает"},ready:{color:"green",label:"Oплаченный"},error:{color:"red",label:"Отменено"},unknown:{color:"gray",label:"Неизвестный"}};return(o,l)=>{var u,i;return y(),v("span",je,[e.status&&"ready"!=e.status||f(t)?(y(),v("button",{key:0,disabled:f(t),onClick:l[0]||(l[0]=()=>f(r)(e.id)),class:"payment_status","data-tooltip":f(t)?"загрузка...":"Проверить статус"},[_(f(B),{class:q(["h-4 w-4",{rotating:f(t)}])},null,8,["class"])],8,Ve)):b("",!0),e.status?(y(),g(G,{key:1,point:!0,color:null==(i=s[null!=(u=e.status)?u:"ready"])?void 0:i.color},{default:w((()=>{var a,t,r;return[S(M(null!=(r=null==(t=s[null!=(a=e.status)?a:"unknown"])?void 0:t.label)?r:e.status),1)]})),_:1},8,["color"])):b("",!0),e.status||f(t)?b("",!0):(y(),g(N,{key:2,onClick:l[1]||(l[1]=()=>(async e=>{await a.paymentWrapper((()=>n(e)))})(e.id))},{default:w((()=>[ke])),_:1}))])}}};export{Oe as _,Y as a,pe as f,$e as s};
