import{_ as e}from"./Work.601ec4a0.js";import{_ as a}from"./Header.5847de72.js";import{_ as l}from"./Input.b03a61c6.js";import{s as t,_ as s}from"./WorkerBadge.cc727e45.js";import{u as o}from"./useSuspense.29183c13.js";import{w as n,a as r,h as u}from"./useAvatar.7737e550.js";import{_ as i}from"./Table.ec42ea9a.js";import{$ as d}from"./drop.cce90c26.js";import{U as m,c as p,V as c,o as f,d as v,j as b,J as j,l as _,t as g,u as w,e as y,P as V,w as k,f as h,ag as x,h as D}from"./vendor.36c281f3.js";import{_ as U}from"./Select.bf4a4e1e.js";import{s as B}from"./employees.2bffecd5.js";import{d as M}from"./index.8fc70fb6.js";import"./meta.48f5205a.js";import"./departments.4f88a00d.js";import"./Button.4b020695.js";import"./ExclamationCircleIcon.22c0ccb9.js";import"./useOrder.941ce970.js";import"./index.e517b156.js";import"./index.ce6adbb1.js";import"./Avatar.4eeca634.js";import"./Spinner.2e0ab286.js";import"./headlessui.esm.b519f347.js";import"./Dropdown.df5c89e3.js";import"./Th.32cd08d3.js";import"./useIntersectionObserver.7ad3d6a4.js";const I=y("small",null,[y("b",null,"NB"),_(" : в один день, даже если задача закрывалась много раз, засчитывается только один раз")],-1),T=y("br",null,null,-1),$=y("small",null,[y("b",null,"NB"),_(" : если другой пользователь играл с вашими задачами, здесь будет отображаться, что вы работали над этими задачами, даже если вы их не трогали")],-1),S={async setup(e){let a,l;const{edge:s,selection:o}=t(),r=864e5,u=m(),y=e=>{var a;return null==(a=new Date(e))?void 0:a.getTime()},V=e=>new Date(e).getDate(),k=(e,a)=>{var l;return a=V(a),null!=(l=null==e?void 0:e.filter((({timestamp:e})=>V(e)===a)))?l:[]},h=(e,a,l)=>{var t,s;const n=y(a),r=y(l);return null!=(s=null==(t=null==e?void 0:e.logs)?void 0:t.filter((({created_at:e,type:a})=>n<=y(e)<=r&&("task_status"==a||"task_created"===a))).map((({created_at:e,data:a,type:l})=>{const t=(e=>{var a,l,t;return null==(t=null==(l=null==(a=null==e?void 0:e.data)?void 0:a.pipelines)?void 0:l.filter((({pipeline_id:e})=>e==o.funnel))[0])?void 0:t.stage_id})({data:a});console.log(a);const s=null==a?void 0:a.status;return{timestamp:y(e),status:s,type:l,stage_id:t}})))?s:[]},x=(e,a)=>{let l=0;if(null==e?void 0:e.length){const t=k(e.sort(((e,a)=>e.timestamp-a.timestamp)),a);if(t.length){const{status:e,timestamp:s}=t[0];"process"!==e&&"wait"!==e&&(l+=s-a);const{status:o,timestamp:n}=t[t.length-1];if("process"===o&&(l+=Math.min(Date.now(),a+r)-n),t.length>1){let e=0;for(;e+1<t.length;){const{status:a,timestamp:s}=t[e],{status:o,timestamp:n}=t[e+1];"process"===a&&"process"!==o&&(l+=n-s),e++}}}}return l},D=(e,a)=>{var l;return(null==(l=k(e,a))?void 0:l.some((({status:e})=>"done"===e)))?1:0},U=p((()=>{var e,a;let l=null!=(t=u.value,n=s.from,i=s.to,e=null==t?void 0:t.map((e=>h(e,n,i))))?e:[];var t,n,i;o.etape&&(l=l.map((e=>((e,a)=>{var l;return null!=(l=null==e?void 0:e.filter((({stage_id:e})=>e==a)))?l:[]})(e,o.etape))));let d=y(s.from);const m=y(s.to),p=[];for(;d<=m;){let e=l.reduce(((e,a)=>e+x(a,d)),0);e=(null!=e?e:0)/6e4;const t=e?`${Math.floor(e/60)}ч ${Math.floor(e%60)}мин`:0,s=null!=(a=l.reduce(((e,a)=>e+D(a,d)),0))?a:0;p.push({day:d,work_time:t,closed_tasks:s}),d+=r}return p})),B=[{label:"Day",key:"day"},{label:"Затраченное время",key:"work_time"},{label:"Количество закрытых задач",key:"closed_tasks"}];return[a,l]=c((()=>(async()=>{u.value=await d.tasks({pipeline_id:o.funnel,user_id:o.user})})())),a=await a,l(),(e,a)=>(f(),v("div",null,[I,T,$,b(i,{fields:B,items:w(U),actions:!1},{"td-day":j((({value:e})=>[_(g(V(e))+" "+g(w(n)[new Date(e).getMonth()]),1)])),"td-work_time":j((({value:e})=>[_(g(e),1)])),"td-closed_tasks":j((({value:e})=>[_(g(e),1)])),_:1},8,["items"])]))}},A=_("Рабочее время"),E={class:"flex flex-wrap gap-2 items-end mt-4"},N={setup(n){const{userRole:i,user:d}=M(),{options:c,load:v}=B,{clearMemo:_,initTimeEdges:g,options:I,selection:T,loadFunnels:$,funnelById:N}=t(),O=o(S);x(_);const W=g(),C=p((()=>{var e;return null==(e=N(T.funnel))?void 0:e.stages.map((({id:e,name:a})=>({label:a,value:e})))})),F=m(""),H=p((()=>{var e,a;return"admin"===(null==(e=i.value)?void 0:e.name)||"director"===(null==(a=i.value)?void 0:a.name)}));return V((async()=>{var e,a,l;await $(),await v(),T.funnel=null==(e=I.value[0])?void 0:e.value,T.user=H.value?null==(a=c.value[0])?void 0:a.value:null==(l=d.value)?void 0:l.id,k(T,r((()=>{F.value=`${T.funnel}-${T.user}`})))})),(t,o)=>(f(),h(e,{title:"Рабочее время"},{default:j((()=>[b(s),b(a,null,{default:j((()=>[A])),_:1}),y("div",E,[b(l,{label:"Дата от",modelValue:w(W).from,"onUpdate:modelValue":o[0]||(o[0]=e=>w(W).from=e),type:"date",max:w(u)(new Date(w(W).to))},null,8,["modelValue","max"]),b(l,{label:"Дата до",modelValue:w(W).to,"onUpdate:modelValue":o[1]||(o[1]=e=>w(W).to=e),type:"date",max:w(u)(new Date),min:w(u)(new Date(w(W).from))},null,8,["modelValue","max","min"]),b(U,{label:"Сотрудник",options:w(c),modelValue:w(T).user,"onUpdate:modelValue":o[2]||(o[2]=e=>w(T).user=e),disabled:!w(H),class:"col-span-4"},null,8,["options","modelValue","disabled"]),b(U,{label:"Воронка",options:w(I),modelValue:w(T).funnel,"onUpdate:modelValue":o[3]||(o[3]=e=>w(T).funnel=e),class:"col-span-4"},null,8,["options","modelValue"]),b(U,{label:"Этап",options:w(C),modelValue:w(T).etape,"onUpdate:modelValue":o[4]||(o[4]=e=>w(T).etape=e),class:"col-span-4"},null,8,["options","modelValue"])]),w(T).user?(f(),h(w(O),{key:w(F)})):D("",!0)])),_:1}))}};export{N as default};
