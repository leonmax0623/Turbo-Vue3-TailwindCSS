var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,o=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,d=(e,a)=>{for(var t in a||(a={}))s.call(a,t)&&o(e,t,a[t]);if(l)for(var t of l(a))r.call(a,t)&&o(e,t,a[t]);return e};import{o as n,f as i,j as c,S as u,r as m,H as f,U as p,c as v,L as b,M as g,V as y,d as w,e as _,W as h,X as x,Y as j,t as k,J as V,u as O,l as B,h as S,K as I,Z as M,n as T,_ as $,w as L,P,A as U,$ as D,a0 as E,a1 as z}from"./vendor.36c281f3.js";import{_ as A}from"./Office.55bfbecd.js";import{_ as C}from"./Button.4b020695.js";import{_ as F}from"./Header.5847de72.js";import{D as W}from"./vuedraggable.umd.d6640c54.js";import{_ as H}from"./Badge.4bd69676.js";import{_ as q}from"./Link.4e9a6f0f.js";import{o as J,s as K,g as N,d as X,h as Y,a as Z}from"./useAvatar.7737e550.js";import{o as G}from"./orders.a1ebe807.js";import{o as Q}from"./stages.6e22bacf.js";import{d as R}from"./departments.4f88a00d.js";import{b as ee,c as ae}from"./index.8fc70fb6.js";import{s as te}from"./index.e517b156.js";import{_ as le}from"./FormActions.47218f8a.js";import{_ as se}from"./Table.ec42ea9a.js";import{_ as re}from"./Select.bf4a4e1e.js";import{s as oe}from"./employees.2bffecd5.js";import{u as de}from"./form.126ebbce.js";import{u as ne}from"./useSuspense.29183c13.js";import{_ as ie}from"./Input.b03a61c6.js";import{_ as ce}from"./StoSelect.c4156f5b.js";import{c as ue}from"./clients.e20f9038.js";import{c as me}from"./cars.41f6223d.js";import"./headlessui.esm.b519f347.js";import"./Avatar.4eeca634.js";import"./Dropdown.df5c89e3.js";import"./NavBar.2f63176e.js";import"./meta.48f5205a.js";import"./drop.cce90c26.js";import"./Spinner.2e0ab286.js";import"./Th.32cd08d3.js";import"./useIntersectionObserver.7ad3d6a4.js";import"./ExclamationCircleIcon.22c0ccb9.js";function fe(e,a){return n(),i("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[c("path",{"fill-rule":"evenodd",d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z","clip-rule":"evenodd"})])}function pe(e,a){return n(),i("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[c("path",{"fill-rule":"evenodd",d:"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z","clip-rule":"evenodd"})])}const ve=ee(),{load:be,state:ge,setOrderStage:ye}=G,{current:we}=R,{state:_e,load:he}=Q,{load:xe,reset:je,state:ke,getTaskById:Ve,options:Oe}=te;let Be,Se,Ie;const Me=()=>{Be.value=(()=>{const e=ge.raw.reduce(((e,a)=>{if(a.stage){const{id:t,color:l,name:s}=a.stage;t in e?e[t].orders.push(a):e[t]={orders:[a],name:s,color:l}}return e}),{});return _e.raw.forEach((({id:a,color:t,name:l})=>{a in e||(e[a]={orders:[],name:l,color:t})})),e})()},Te=async(e,a)=>{var t,l;const s=new Date,{item:{id:r},to:{id:o}}=e;if((null==(l=null==(t=ge.raw.find((({id:e})=>e==r)))?void 0:t.stage)?void 0:l.id)==o)return;const{message:d,success:n}=await K({data:{order_stage_id:o},path:`orders/${r}/stage`});if(!n)return ve.danger(null!=d?d:"Что-то пошло не так"),Me();ye(r,_e.raw.find((({id:e})=>e==o))),ve.success("Стадия заказа успешно обновлена"),await a(s,r)},$e=async()=>{var e,l;await Promise.all([async()=>je(),be((e=d({},Se),l={department_id:we.value},a(e,t(l)))),he()]).then(Me)};var Le=()=>u().run((()=>(Be||(Be=m({}),Se=f({}),Ie=p(!1)),{atMounted:$e,columns:Be,filter:Se,log:Te,toaster:ve,current:we,tasksState:ke,showModal:Ie,loadTasks:xe,getTaskById:Ve,state:ge,reset:je,taskOptions:Oe,sig:v((()=>J(Se))),clearMemo:()=>{Be=void 0,Se=void 0},resetFilter:()=>{Se.client_id="",Se.car_id="",Se.created_before="",Se.created_after=""}})));b("data-v-1ac667ee");const Pe={class:"mb-16 relative"},Ue={class:"text-gray-700 font-semibold font-sans tracking-wide text-sm"},De=["id"],Ee={class:"flex justify-between"},ze={class:"text-xs"},Ae={class:"flex flex-col items-end"},Ce=["src","title"],Fe={class:"flex mt-4 justify-between items-center flex-wrap"},We={class:"text-sm text-gray-600"},He={class:"overflow-hidden overlay absolute my-auto z-50 right-0 left-0 bottom-0 top-0 flex items-center opacity-30"},qe={class:"absolute p-9 bg-gray-600 inset-0 flex justify-center items-center bg-opacity-75 z-50"},Je={class:"bg-white rounded-md px-3 py-6 mt-12 shadow-2xl w-full max-w-3xl m-6"},Ke={class:"p-1 overflow-y-scroll max-h-vw"},Ne=_("h1",{class:"text-lg mb-m text-center"},"Автоматически созданные задачи",-1),Xe=_("p",{class:"text-xs text-gray-600 text-center"},"Укажите ответственного для задачи",-1);g();const Ye={async setup(e){let a,t;const{load:l,options:s}=oe,{current:r}=R,{columns:o,log:d,atMounted:u,tasksState:m,showModal:b,loadTasks:g,getTaskById:L,toaster:P,taskOptions:U,reset:D}=Le();[a,t]=y((()=>u())),a=await a,t();const E=f({}),z=async(e,a)=>{await Promise.all([l({department_id:r.value}),D(),g({department_id:r.value,order_id:a,created_after:Y(e)},!1)]).then((()=>{U.value.length&&(b.value=!0)}))},A=v((()=>m.raw.filter((({user:e})=>!e)))),C=p(!1),F=p(),J=async()=>{F.value=void 0,C.value=!0;try{await Promise.all(Object.entries(E).map((([e,a])=>(async(e,a)=>{if(!a)return;const t=L(e);if(!t)return;const{message:l,success:s}=await de(t,a);return s||F.value||(F.value=`${null!=l?l:"Что-то пошло не так"} (с этой задачей ${t.name})`),{message:l,success:s}})(e,a)))).then((e=>{e.every((({success:e})=>e))&&(b.value=!1,P.success("Задачи успешно сохранены"))}))}finally{C.value=!1}},K=p(),Z=p(0);let G;const Q=()=>{null!=G&&(clearInterval(G),G=void 0)},ee=(e=!1)=>{Q(),G=setInterval((()=>{var a;let t=null!=(a=K.value)?a:document.getElementById("orders-kanban"),l=e?t.scrollLeft+70:t.scrollLeft-70;requestAnimationFrame((()=>{t.scroll({left:l,behavior:"smooth"})}))}),60)},te=[{label:"Тип",key:"type"},{label:"Название",key:"name"},{label:"Исполнитель",key:"user"}];return(e,a)=>(n(),w("div",null,[_("div",Pe,[_("div",{onScroll:a[1]||(a[1]=()=>(()=>{var e;let a=null!=(e=K.value)?e:document.getElementById("orders-kanban");return 0===a.scrollLeft?(Q(),void(Z.value=0)):a.scrollLeft+a.clientWidth>=a.scrollWidth-1?(Q(),void(Z.value=1)):void(Z.value=2)})()),id:"orders-kanban",ref:e=>K.value=e,class:"flex gap-5 items-stretch overflow-x-scroll pb-5"},[(n(!0),w(h,null,x(Object.entries(O(o)),(([e,{name:t,color:l}])=>(n(),w("div",{key:e,class:"rounded-lg p-3 stage overflow-y-scroll no-scrol-scroll-thum",style:j({background:l})},[_("p",Ue,k(t),1),c(O(W),{"item-key":"id",modelValue:O(o)[e].orders,"onUpdate:modelValue":a=>O(o)[e].orders=a,group:"orders","ghost-class":"ghost",class:"tasks-container",id:e,onEnd:a[0]||(a[0]=e=>O(d)(e,z)),disabled:!O(ae)("crud orders")},{item:V((({element:e})=>{var a,t,l,s,r;return[(n(),w("div",{class:"bg-white shadow rounded px-3 pt-3 my-2 pb-5 border w-full",key:e.id,id:e.id},[_("div",Ee,[_("div",null,[c(q,{disabled:!O(ae)("crud orders"),class:"font-semibold font-sans tracking-wide text-sm",href:{name:"OrderEdit",params:{id:e.id}}},{default:V((()=>[B(" Заказ-наряд #"+k(O(N)(e.id)),1)])),_:2},1032,["disabled","href"]),_("div",ze,[c(q,{disabled:!0},{default:V((()=>[B("Задач: "+k(e.count_tasks),1)])),_:2},1024)])]),_("div",Ae,[c(q,null,{default:V((()=>{var a,t,l,s;return[_("img",{class:"w-8 h-8 rounded-full ml-3",src:null!=(t=null==(a=e.user)?void 0:a.avatar)?t:O(X).avatar,title:`${null==(l=e.user)?void 0:l.name} ${null==(s=e.user)?void 0:s.middle_name}`},null,8,Ce)]})),_:2},1024)])]),_("div",Fe,[_("span",We,k(e.created_at.split(" ")[0]),1),(null==(l=null==(t=null==(a=null==e?void 0:e.car)?void 0:a.car_model)?void 0:t.car_mark)?void 0:l.name)||(null==(r=null==(s=null==e?void 0:e.car)?void 0:s.car_model)?void 0:r.name)?(n(),i(H,{key:0,color:"blue",class:"text-lg",point:!0},{default:V((()=>{var a,t,l,s,r,o,d;return[B(k(`${null!=(s=null==(l=null==(t=null==(a=null==e?void 0:e.car)?void 0:a.car_model)?void 0:t.car_mark)?void 0:l.name)?s:""} ${null!=(d=null==(o=null==(r=null==e?void 0:e.car)?void 0:r.car_model)?void 0:o.name)?d:"_"}`.substr(0,20)),1)]})),_:2},1024)):S("",!0)])],8,De))]})),_:2},1032,["modelValue","onUpdate:modelValue","id","disabled"])],4)))),128))],544),_("div",He,[c(M,{tag:"div",name:"slide-fade-left"},{default:V((()=>[0!==O(Z)?(n(),w("span",{key:0,onMouseenter:a[2]||(a[2]=I((()=>ee()),["prevent"])),onMouseleave:Q,class:"chevron chevron-left bg-gray-900 opacity-75 py-5 rounded-r-full top-1/4 left-0 flex items-center"},[c(O(fe),{class:"text-white w-16"})],32)):S("",!0)])),_:1}),c(M,{tag:"div",name:"slide-fade-right"},{default:V((()=>[1!==O(Z)?(n(),w("span",{key:0,onMouseenter:a[3]||(a[3]=()=>ee(!0)),onMouseleave:Q,class:"ml-auto chevron chevron-right bg-gray-900 opacity-75 py-5 rounded-l-full top-1/4 right-0 flex items-center"},[c(O(pe),{class:"text-white w-16"})],32)):S("",!0)])),_:1})])]),O(A).length&&O(b)?(n(),i($,{key:0,to:"#sto-modal-teleport"},[c(M,{name:"docs-modal"},{default:V((()=>[_("div",qe,[_("div",Je,[_("div",Ke,[Ne,Xe,_("p",{class:T(["text-xs text-center my-3 select-none",O(F)?"text-red-500":"text-transparent"])},k(O(F)?O(F):"a"),3),c(se,{onBottomTouched:a[4]||(a[4]=()=>{}),fields:te,items:O(A),actions:!1},{"td-name":V((({value:e,item:{id:a}})=>[c(q,{href:{name:"Task",params:{id:a}}},{default:V((()=>[B(k(e),1)])),_:2},1032,["href"])])),"td-type":V((({item:{is_map:e}})=>[c(H,{point:!0,color:e?"green":"purple"},{default:V((()=>[B(k(e?"Диагностическая карта":"Задачa"),1)])),_:2},1032,["color"])])),"td-user":V((({item:e})=>[c(re,{modelValue:O(E)[e.id],"onUpdate:modelValue":a=>O(E)[e.id]=a,options:O(s),class:"w-full z-50"},null,8,["modelValue","onUpdate:modelValue","options"])])),_:1},8,["items"])]),c(le,{loading:O(C),onClose:a[5]||(a[5]=()=>{b.value=!1}),onSubmited:a[6]||(a[6]=()=>J())},null,8,["loading"])])])])),_:1})])):S("",!0)]))},__scopeId:"data-v-1ac667ee"};const Ze={key:0,class:"flex flex-wrap gap-2 items-start"},Ge={class:"w-full user"},Qe={class:"w-full user"},Re={class:"text-center ml-3 flex flex-col items-center"},ea=B("сбросить"),aa={setup(e){const{options:a,fill:t,reset:l}=ue,{options:s,fill:r,reset:o}=me,{filter:d,current:i,resetFilter:u}=Le();return L(i,(e=>{l(),t({department_id:e})}),{immediate:!0}),P((async()=>{o(),await r()})),(e,l)=>{const o=U("Label");return O(d)?(n(),w("div",Ze,[c(ie,{label:"Дата от",type:"date",modelValue:O(d).created_after,"onUpdate:modelValue":l[0]||(l[0]=e=>O(d).created_after=e),max:O(Y)(new Date)},null,8,["modelValue","max"]),c(ie,{label:"Дата до",type:"date",modelValue:O(d).created_before,"onUpdate:modelValue":l[1]||(l[1]=e=>O(d).created_before=e),max:O(Y)(new Date)},null,8,["modelValue","max"]),_("div",Ge,[c(ce,{label:"Клиент",modelValue:O(d).client_id,"onUpdate:modelValue":l[2]||(l[2]=e=>O(d).client_id=e),options:O(a),class:"w-full",onBottomTouched:l[3]||(l[3]=()=>O(t)({department_id:O(i)})),search:""},null,8,["modelValue","options"])]),_("div",Qe,[c(ce,{label:"Автомобиль",modelValue:O(d).car_id,"onUpdate:modelValue":l[4]||(l[4]=e=>O(d).car_id=e),options:O(s),class:"w-full",onBottomTouched:l[5]||(l[5]=()=>O(r)()),search:""},null,8,["modelValue","options"])]),_("div",Re,[c(o,null,{default:V((()=>[ea])),_:1}),c(C,{type:"secondary",class:"rounded-full",onClick:l[6]||(l[6]=()=>O(u)())},{default:V((()=>[c(O(D),{class:"h-4 w-4 text-gray-600"})])),_:1})])])):S("",!0)}}},ta=B("Этапы "),la=B("Создать "),sa=B("Фильтр"),ra={setup(e){const{current:a}=R,{sig:t}=Le(),l=m("random");L(t,Z((()=>{l.value=Date.now()})));const s=ne();return(e,t)=>{const r=U("v-can");return n(),i(A,{title:"Заказ-наряды"},{actions:V((()=>[c(C,{type:"secondary",link:{name:"OrderStages"}},{default:V((()=>[c(O(E),{class:"w-5 h-5 mr-1"}),ta])),_:1}),c(r,{ability:"crud orders"},{default:V((()=>[c(C,{color:"blue",link:{name:"OrderForm"}},{default:V((()=>[c(O(z),{class:"w-5 h-5 mr-1"}),la])),_:1})])),_:1})])),default:V((()=>[c(F,null,{default:V((()=>[sa])),_:1}),c(aa),O(a)?(n(),i(O(s),{key:`orders-${O(a)}-${l.value}`},{default:V((()=>[c(Ye)])),_:1})):S("",!0)])),_:1})}}};export{ra as default};
