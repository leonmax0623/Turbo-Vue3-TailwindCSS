var e=Object.defineProperty,a=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,l=(a,s,t)=>s in a?e(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t,o=(e,o)=>{for(var r in o||(o={}))s.call(o,r)&&l(e,r,o[r]);if(a)for(var r of a(o))t.call(o,r)&&l(e,r,o[r]);return e};import{_ as r}from"./Work.601ec4a0.js";import{_ as n}from"./Header.5847de72.js";import{_ as i}from"./Select.bf4a4e1e.js";import{s as d,_ as u}from"./WorkerBadge.cc727e45.js";import{u as c}from"./useSuspense.29183c13.js";import{D as m}from"./vuedraggable.umd.d6640c54.js";import{_ as p}from"./Badge.4bd69676.js";import{_ as f}from"./Link.4e9a6f0f.js";import{o as v,s as g,f as b,d as y,g as j,l as k}from"./useAvatar.7737e550.js";import{p as _}from"./index.ce6adbb1.js";import{b as w,e as x,f as h}from"./index.8fc70fb6.js";import{s as S}from"./index.e517b156.js";import{S as O,r as F,c as V,L as I,M as $,V as B,o as M,d as P,e as U,W,X as A,u as E,Y as J,t as L,j as N,J as T,n as q,l as D,h as H,U as K,P as X,w as Y,f as z,ag as C,aA as G}from"./vendor.36c281f3.js";import"./meta.48f5205a.js";import"./departments.4f88a00d.js";import"./drop.cce90c26.js";import"./Button.4b020695.js";import"./useOrder.941ce970.js";import"./Avatar.4eeca634.js";import"./Spinner.2e0ab286.js";const Q=w(),{state:R,load:Z,options:ee,funnelById:ae}=_,{tasksInFunnel:se,state:te,setTaskFunnelStage:le,reset:oe,fill:re}=S;let ne,ie,de,ue;const ce=e=>{if(!e)return{};const a=ae(e),s=se(e);return null==a?void 0:a.stages.reduce(((a,t)=>{const{id:l,color:o,name:r}=t,n=s.filter((({pipelines:a})=>a.some((({pipeline:a,stage:s})=>(null==a?void 0:a.id)==e&&(null==s?void 0:s.id)==l))));return a[l]={tasks:n,name:r,color:o},a}),{})},me=e=>{de.value=ce(e)},pe=async e=>{var a,s;const{item:{id:t},to:{id:l}}=e,o=ie.value,r=te.raw.find((({id:e})=>e==t));if(!r)return me(o);if("process"===(null==r?void 0:r.status))return Q.warn("Вы не можете изменить этап, пока задача активна",""),me(o);if((null==(s=null==(a=null==r?void 0:r.pipelines.find((({pipeline:e})=>e.id==o)))?void 0:a.stage)?void 0:s.id)==l)return;const{message:n,success:i}=await g({data:{stage_id:l},path:`tasks/${t}/pipelines/${o}/stage`});if(!i)return Q.danger(null!=n?n:"Что-то пошло не так"),me(o);const d=ae(o).stages.find((({id:e})=>e==l));return le(t,o,d),Q.success("Этап изменен")},fe=async()=>{await ue(!0,{pipeline_id:ie.value}),me(ie.value)};var ve=()=>O().run((()=>{const{filter:e,resetFilter:a}=d();return ie||(ie=F()),de||(de=F({}),ne=e,ue=async(e=!0,a)=>{e&&oe(),await re(o(o({},b(ne)),a),!1)}),{getKanBanPayload:ce,atMounted:fe,filter:ne,log:pe,columns:de,state:te,options:ee,theSelectedFunnel:ie,sig:V((()=>v(ne))),resetFilter:a,loadFunnels:Z,clearMemo:()=>{ne=void 0,ue=void 0,de=void 0}}}));I("data-v-7c66ad6f");const ge={class:"mb-8 relative"},be={class:"grid grid-cols-12 gap-3 pb-5"},ye={class:"text-gray-700 font-semibold font-sans tracking-wide text-sm"},je=["id"],ke={class:"flex justify-between"},_e={class:"flex flex-col items-end"},we=["src","title"],xe={key:0,class:"mb-2"},he={class:"text-sm text-gray-600"},Se={key:1},Oe={class:"flex mt-2 justify-between items-center"},Fe={class:"text-sm text-gray-600"};$();const Ve={async setup(e){let a,s;const{log:t,atMounted:l,state:o,columns:r}=ve();[a,s]=B((()=>l())),a=await a,s();const n=x(["update stage tasks","update department stage tasks","update own stage tasks"]),i=e=>h(e,"update_stage");return(e,a)=>(M(),P("div",ge,[U("div",be,[(M(!0),P(W,null,A(Object.entries(E(r)),(([e,{name:a,color:s}])=>(M(),P("div",{key:e,class:"rounded-lg p-3 col-span-12 sm:col-span-6 lg:col-span-4 xl:col-span-3 stage overflow-y-scroll no-scrol-scroll-thum",style:J({background:s})},[U("p",ye,L(a),1),N(E(m),{"item-key":"id",modelValue:E(r)[e].tasks,"onUpdate:modelValue":a=>E(r)[e].tasks=a,group:"tasks","ghost-class":"ghost",class:"tasks-container",id:e,onEnd:E(t),disabled:!E(n),draggable:".draggable"},{item:T((({element:e})=>{var a,s,t,l;return[(M(),P("div",{class:q([" shadow rounded px-3 pt-3 my-2 pb-5 border w-full select-none cursor-pointer",i(e)?"draggable bg-white":"bg-gray-100 opacity-60"]),key:e.id,id:e.id},[U("div",ke,[U("div",null,[N(f,{disabled:!i(e),class:"font-semibold font-sans tracking-wide text-sm",href:{name:"WorkerTask",params:{id:e.id},query:{from:"kanban"}}},{default:T((()=>[D(L(e.name),1)])),_:2},1032,["disabled","href"])]),U("div",_e,[N(f,null,{default:T((()=>{var a,s,t,l;return[U("img",{class:"w-8 h-8 rounded-full ml-3",src:null!=(s=null==(a=e.user)?void 0:a.avatar)?s:E(y).avatar,title:`${null==(t=e.user)?void 0:t.name} ${null==(l=e.user)?void 0:l.middle_name}`},null,8,we)]})),_:2},1024)])]),(null==(a=e.order)?void 0:a.id)?(M(),P("div",xe,[U("span",he,"Заказ-наряд #"+L(E(j)(null==(s=e.order)?void 0:s.id)),1)])):H("",!0),(null==(l=null==(t=null==e?void 0:e.order)?void 0:t.car)?void 0:l.car_model)?(M(),P("div",Se,[N(p,{color:"blue",point:!0},{default:T((()=>{var a,s,t,l,o,r,n,i,d;return[D(L(`${null!=(o=null==(l=null==(t=null==(s=null==(a=null==e?void 0:e.order)?void 0:a.car)?void 0:s.car_model)?void 0:t.car_mark)?void 0:l.name)?o:""} ${null!=(d=null==(i=null==(n=null==(r=null==e?void 0:e.order)?void 0:r.car)?void 0:n.car_model)?void 0:i.name)?d:"_"}`),1)]})),_:2},1024)])):H("",!0),U("div",Oe,[U("span",Fe,L(e.created_at.split(" ")[0]),1),N(p,{point:!0,color:E(k)[e.status].color},{default:T((()=>[D(L(E(k)[e.status].label),1)])),_:2},1032,["color"])])],10,je))]})),_:2},1032,["modelValue","onUpdate:modelValue","id","onEnd","disabled"])],4)))),128))])]))}};function Ie(e,a){const s=K(function(e,a){const s=localStorage.getItem(e);return s?JSON.parse(s):"function"==typeof a?a():a}(e,a));return[s,a=>{localStorage.setItem(e,JSON.stringify(a)),s.value=a}]}Ve.__scopeId="data-v-7c66ad6f";const $e=D("Канбан"),Be={class:"grid grid-cols-12"},Me={setup(e){const a=c(Ve),{clearMemo:s,options:t,theSelectedFunnel:l,loadFunnels:o}=ve();return C(s),X((async()=>{var e;await o();const[a,s]=Ie("kanban_funnel",null==(e=t.value[0])?void 0:e.value);l.value=a.value,Y(l,s)})),(e,s)=>(M(),z(r,{title:"Канбан"},{default:T((()=>[N(u),N(n,null,{default:T((()=>[$e])),_:1}),U("div",Be,[N(i,{options:E(t),modelValue:E(l),"onUpdate:modelValue":s[0]||(s[0]=e=>G(l)?l.value=e:null),class:"col-span-4 mb-0"},null,8,["options","modelValue"])]),E(l)?(M(),z(E(a),{key:E(l)})):H("",!0)])),_:1}))}};export{Me as default};
