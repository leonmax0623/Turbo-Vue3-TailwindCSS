import{V as s,w as e,c as a,o as t,d as o,j as r,u as l,S as d,H as u,ag as i,f as n,J as c,l as m,t as p,e as b,aP as f}from"./vendor.36c281f3.js";import{_}from"./Button.4b020695.js";import{_ as v}from"./Input.b03a61c6.js";import{_ as j}from"./Select.bf4a4e1e.js";import{a as y,s as g}from"./storage-requests.df03da5b.js";import{s as V}from"./index.d9cbb9ba.js";import{d as w}from"./departments.4f88a00d.js";import{_ as q}from"./StoSelect.c4156f5b.js";import{l as h,c as k,s as S}from"./useAvatar.7737e550.js";import{u as E}from"./useModalForm.1c23c14e.js";import{a as O,b as U}from"./index.8fc70fb6.js";import{$ as x}from"./drop.cce90c26.js";import{a as B}from"./OrderForm.cc8dadca.js";import{_ as C}from"./Badge.4bd69676.js";import{_ as D}from"./Link.4e9a6f0f.js";import{_ as F}from"./Table.ec42ea9a.js";import{u as A}from"./useConfirmDialog.ba73d887.js";import{u as I}from"./useSuspense.29183c13.js";import"./ExclamationCircleIcon.22c0ccb9.js";import"./useIntersectionObserver.7ad3d6a4.js";import"./FormActions.47218f8a.js";import"./Spinner.2e0ab286.js";import"./Office.55bfbecd.js";import"./headlessui.esm.b519f347.js";import"./Avatar.4eeca634.js";import"./Dropdown.df5c89e3.js";import"./NavBar.2f63176e.js";import"./meta.48f5205a.js";import"./orders.a1ebe807.js";import"./Th.32cd08d3.js";import"./Dialog.b36041f9.js";const M={async setup(d){let u,i;const{items:n,atMounted:c,products_request:m}=L(),{current:p}=w,{load:b,options:f,findProduct:_}=y,{load:k,options:S}=V,{loadStatuses:E,state:O}=g;let U;[u,i]=s((()=>Promise.all([k({department_id:p.value}),E(),c()]).then((()=>{U=O.statuses.map((s=>({label:h[s].label,value:s})))})))),u=await u,i(),e((()=>m.storage_id),(async s=>{await b({storage_id:s})}));const x=a((()=>_(m.product_id)));return e(x,(s=>{m.sum=null==s?void 0:s.output_sum})),(s,e)=>(t(),o("div",null,[r(j,{label:"Склад",options:l(S),required:!0,modelValue:l(m).storage_id,"onUpdate:modelValue":e[0]||(e[0]=s=>l(m).storage_id=s),class:"mb-3 sm:col-span-6 col-span-12"},null,8,["options","modelValue"]),r(q,{disabled:!l(m).storage_id,label:"Товар",search:!0,options:l(f),required:!0,modelValue:l(m).product_id,"onUpdate:modelValue":e[1]||(e[1]=s=>l(m).product_id=s),class:"mb-3 sm:col-span-6 col-span-12",onBottomTouched:e[2]||(e[2]=()=>s.fill({client_id:s.fields.client_id}))},null,8,["disabled","options","modelValue"]),r(v,{disabled:!l(m).product_id,label:"Цена продажи",type:"number",required:!0,modelValue:l(m).sum,"onUpdate:modelValue":e[3]||(e[3]=s=>l(m).sum=s),class:"mb-3 sm:col-span-6 col-span-12"},null,8,["disabled","modelValue"]),r(v,{label:"Количество",type:"number",required:!0,modelValue:l(m).count,"onUpdate:modelValue":e[4]||(e[4]=s=>l(m).count=s),class:"mb-3 sm:col-span-6 col-span-12"},null,8,["modelValue"]),r(j,{label:"Статус",options:l(U),required:!0,modelValue:l(m).status,"onUpdate:modelValue":e[5]||(e[5]=s=>l(m).status=s),class:"mb-3 sm:col-span-6 col-span-12"},null,8,["options","modelValue"])]))}},P=U(),{add:T}=g;let H;function J(s){var e,a,t;if(s.includes("_id"))return"storage_id"===s?void(H.storage_id=null==(a=null==(e=null==this?void 0:this.product)?void 0:e.storage)?void 0:a.id):void(H[s]=null==(t=this[s.replace("_id","")])?void 0:t.id);H[s]=this[s]}const K=async()=>{const{id:s}=H;if(!s)return;const{success:e,product_request:a}=await x({key:`products-requests/${s}`});e&&((s={})=>{Object.keys(H).forEach(J,s)})(a)};function L(){const{route:s}=O();return{render:(...e)=>{const t=d();t.run((()=>{const o=a((()=>!!H.id)),{render:r}=E({title:a((()=>k.modal[o.value?"update":"create"].products_request)),RawForm:M,atSubmit:()=>(async s=>{const{message:e,success:a,data:t}=await S.products_request(H);try{return{message:e,success:a}}finally{a&&(T(t.product_request),await B(s),P.success(e))}})(s.params.id),atClose:()=>t.stop(),atOpen:e=>{H=u({id:null!=e?e:"",status:"",count:"",order_id:s.params.id,product_id:"",storage_id:"",sum:""})}});r(...e),i((()=>{H=void 0}))}))},atMounted:K,products_request:H}}const N={class:"font-bold"},R={class:"font-bold"},$={class:"font-bold"},z=m("суммa"),G={async setup(e){let a,o;const{route:d}=O(),{drop:u}=A(),{state:i,drop:f,load:_}=g,{render:v}=L(),j=[{label:"Товар",key:"product"},{label:"Цена закупки (₽)",key:"buy"},{label:"Цена продажи (₽)",key:"sum"},{label:"Kоличество",key:"count"},{label:"Статус",key:"status"},{label:"Дата добавления",key:"created_at"}];return[a,o]=s((()=>_({order_id:d.params.id}))),a=await a,o(),(s,e)=>(t(),n(F,{fields:j,items:l(i).raw,onDelete:e[0]||(e[0]=s=>l(u)((()=>(async s=>{const e=await f(s);try{return e}finally{await B(d.params.id)}})(s)))),onEdit:e[1]||(e[1]=s=>l(v)(s)),noEdit:()=>!0,last:!!l(i).raw.length},{"td-product":c((({value:s})=>[r(D,{disabled:!0},{default:c((()=>[m(p(null==s?void 0:s.name),1)])),_:2},1024)])),"td-count":c((({value:s})=>[b("span",N,p(s),1)])),"td-buy":c((({item:{product:s}})=>[b("span",R,p(null==s?void 0:s.input_sum)+" ₽",1)])),"td-sum":c((({value:s})=>[b("span",$,p(s)+" ₽",1)])),"td-status":c((({value:s})=>{var e;return[r(C,{point:!0,color:null==(e=l(h)[s])?void 0:e.color},{default:c((()=>{var e;return[m(p(null==(e=l(h)[s])?void 0:e.label),1)]})),_:2},1032,["color"])]})),"td-created_at":c((({value:s})=>[m(p(null==s?void 0:s.split(" ")[0]),1)])),"td-last-product":c((({})=>[z])),"td-last-buy":c((({items:s})=>[m(p(s.reduce(((s,e)=>{var a;return s+(null!=(a=e.product.input_sum)?a:0)*e.count}),0))+" ₽",1)])),"td-last-sum":c((({items:s})=>[m(p(s.reduce(((s,e)=>{var a;return s+(null!=(a=e.sum)?a:0)*e.count}),0))+" ₽",1)])),_:1},8,["items","noEdit","last"]))}},Q={class:"mb-5"},W=m("Добавить запчасть "),X={setup(s){const e=I(G),{render:a}=L();return(s,d)=>(t(),o("div",null,[b("div",Q,[r(_,{color:"blue",onClick:d[0]||(d[0]=()=>l(a)())},{default:c((()=>[r(l(f),{class:"w-5 h-5 mr-1"}),W])),_:1})]),r(l(e))]))}};export{X as default};
