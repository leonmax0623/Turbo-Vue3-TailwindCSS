var e=Object.defineProperty,i=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,d=(i,s,a)=>s in i?e(i,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[s]=a,l=(e,i)=>{for(var s in i||(i={}))t.call(i,s)&&d(e,s,i[s]);if(a)for(var s of a(i))r.call(i,s)&&d(e,s,i[s]);return e},n=(e,a)=>i(e,s(a));import{a as o,b as p}from"./index.8fc70fb6.js";import{$ as c}from"./drop.cce90c26.js";import{u,s as _,h as m}from"./useAvatar.7737e550.js";import{d as f}from"./departments.4f88a00d.js";import{s as v}from"./index.e517b156.js";import{S as b,H as k,r as h,ag as y}from"./vendor.36c281f3.js";const{setTask:g}=v,j=p(),{current:x}=f,O={id:"",name:"",description:"",order_id:"",user_id:"",deadline_at:"",position:"",status:"",start_at:"",end_at:"",is_map:"false",map_id:""},w={checkboxes:[{description:""}],pipelines:[{}],temp_file_ids:[],delete_file_ids:[],files:[]};let P,E;const T=(e,i,s)=>{var a,t,r,d,l,n,o,p;if(i.includes("_id")){if("temp_file_ids"===i)return;if("delete_file_ids"===i)return;return"map_id"===i?void(e.map_id=null==(a=s.task_map)?void 0:a.map_id):void(e[i]=null==(t=s[i.replace("_id","")])?void 0:t.id)}if("is_map"!==i){if("pipelines"!==i)return"checkboxes"===i?(e.checkboxes=null!=(l=s.checkboxes)?l:O.checkboxes,void(0===(null==(n=e.checkboxes)?void 0:n.length)&&e.checkboxes.push(""))):void(["end_at","start_at","deadline_at"].includes(i)?e[i]=m(s[i]):e[i]=null!=(p=null!=(o=s[i])?o:O[i])?p:w[i]);s.pipelines&&0!==(null==(r=s.pipelines)?void 0:r.length)?e.pipelines=null==(d=s.pipelines)?void 0:d.map((({pipeline:{id:e},stage:i})=>({pipeline_id:e,stage_id:null==i?void 0:i.id}))):e.pipeline=[{}]}else e.is_map=s.is_map?"true":"false"},q=function(e){T(P,e,this)},D=e=>{E.value=e.target.files},S=async(e,i)=>{const s={id:"",name:"",description:"",order_id:"",user_id:"",deadline_at:"",position:"",status:"",start_at:"",end_at:"",is_map:"false",map_id:"",checkboxes:[{description:""}],pipelines:[{}],temp_file_ids:[],delete_file_ids:[],files:[]};Object.keys(s).forEach((function(e){T(s,e,this)}),e);const{data:a,success:t,message:r}=await _.task(n(l({},s),{user_id:i,department_id:x.value,is_map:"true"==s.is_map}));try{return{success:t,message:r}}finally{t&&g(null==a?void 0:a.task)}};var A=()=>b().run((()=>{const{route:e,isThePage:i,redirectTo:s,back:a}=o("TaskEdit"),{order_id:t}=e.query;P||(P=k({id:"",name:"",description:"",order_id:"",user_id:"",deadline_at:"",position:"",status:"",start_at:"",end_at:"",is_map:"false",map_id:"",checkboxes:[{description:""}],pipelines:[{}],temp_file_ids:[],delete_file_ids:[],files:[]}),E=h());return y((()=>{P=void 0,E=void 0})),{fields:P,isEditPage:i,saveTask:async()=>{var e,i,a,r;const d=null!=(i=null==(e=E.value)?void 0:e.length)?i:0;if(d){const e=new FormData;for(let a=0;a<d;a++)e.append("files[]",E.value[0]);const{message:i,success:s,data:t}=await u("temp/files",e);if(s?j.success("Файлы успешно загружены"):j.danger(null!=i?i:"Что-то пошло не так, не удалось загрузить файлы"),!s)return;P.temp_file_ids=null==(a=null==t?void 0:t.files)?void 0:a.map((({id:e})=>e))}const{data:o,success:p}=await _.task(n(l({},P),{is_map:"true"==P.is_map,department_id:x.value}),null,!0);if(p){if(null!=t)return void s({name:"OrderEdit",params:{id:t},query:{tab:"tasks"}});s({name:"Task",params:{id:null==(r=null==o?void 0:o.task)?void 0:r.id}})}},atMounted:async()=>{if(i.value){const{id:i}=e.params;if(i){let i={};i=await c.task(e.params.id),await(async e=>{Object.keys(P).forEach(q,null!=e?e:{})})(i)}}else t&&(P.order_id=t)},log:D,route:e,back:a}}));export{A as s,S as u};
